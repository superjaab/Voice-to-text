<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Voice to Text</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #f0f2f5;
      padding: 30px;
      color: #333;
    }

    h2 {
      text-align: center;
      color: #2b6777;
      margin-bottom: 20px;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    button {
      background: #2b6777;
      color: white;
      border: none;
      border-radius: 8px;
      margin: 5px 3px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #3f8a99;
    }

    button.active {
      background: #4caf50 !important;
    }

    button.stopped {
      background: #d32f2f !important;
    }

    #status {
      margin-top: 15px;
      font-style: italic;
    }

    #status.listening {
      color: #4caf50;
      font-weight: bold;
    }

    #status.stopped {
      color: #d32f2f;
      font-weight: bold;
    }

    .entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
      font-size: 15px;
    }

    .text-line {
      flex: 1;
      color: #333;
    }

    .entry-buttons {
      display: flex;
      gap: 8px;
      margin-left: 10px;
    }

    .entry-buttons button {
      background: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .entry-buttons button:hover {
      background: #ccc;
    }

    #output, #saved {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      background: #fafafa;
    }

    #saved {
      background: #fdfdfd;
    }

    #mic-bar {
      width: 100%;
      height: 12px;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 10px;
    }

    #mic-level {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.1s ease;
    }

    #mic-device {
      margin-top: 8px;
      color: #555;
      font-size: 14px;
    }

    h3 span button {
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé§ ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° By. Super</h2>
    <div style="text-align: center;">
      <button id="startBtn" onclick="startListening()">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á</button>
      <button id="stopBtn" onclick="stopListening()">‚õî ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á</button>
      <button onclick="saveToPage()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
    </div>

    <div id="mic-bar"><div id="mic-level"></div></div>
    <div id="mic-device">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡∏Ñ‡πå...</div>
    <div id="status" class="stopped">[‡πÑ‡∏°‡∏Ñ‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô]</div>

    <h3 style="display: flex; align-items: center; justify-content: space-between;">
      <span>üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î:</span>
      <span>
        <button onclick="copyText()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
        <button onclick="clearCurrentText()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
      </span>
    </h3>
    <div id="output">[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà]</div>

    <h3>üìö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ:</h3>
    <div id="saved">[‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å]</div>
  </div>

  <script>
    const output = document.getElementById("output");
    const saved = document.getElementById("saved");
    const status = document.getElementById("status");
    const micLevel = document.getElementById("mic-level");
    const micDevice = document.getElementById("mic-device");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    let allText = "";
    let isListening = false;
    let userWantsToListen = false;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      output.textContent = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech Recognition";
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = 'th-TH';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onstart = () => {
        isListening = true;
        status.textContent = "üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... (‡∏Å‡∏î Spacebar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î)";
        status.classList.remove("stopped");
        status.classList.add("listening");
        startBtn.classList.add("active");
        stopBtn.classList.remove("stopped");
      };

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const transcript = event.results[i][0].transcript.trim();
          if (event.results[i].isFinal) {
            allText += transcript + " ";
          } else {
            interim = transcript;
          }
        }
        output.textContent = allText + (interim ? "... " + interim + " ..." : "");
      };

      recognition.onerror = (event) => {
        output.textContent += "\n[‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + event.error + "]";
        status.textContent = "[‡πÑ‡∏°‡∏Ñ‡πå‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô]";
      };

      recognition.onend = () => {
        isListening = false;
        status.textContent = "[‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß] (‡∏Å‡∏î Spacebar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°)";
        status.classList.remove("listening");
        status.classList.add("stopped");
        startBtn.classList.remove("active");
        stopBtn.classList.add("stopped");
        if (userWantsToListen) recognition.start();
      };

      window.startListening = function () {
        if (!isListening) {
          userWantsToListen = true;
          recognition.start();
          output.textContent = allText || "[‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...]";
          initMicMonitor();
        }
      };

      window.stopListening = function () {
        userWantsToListen = false;
        recognition.stop();
        stopMicMonitor();
      };

      window.copyText = function () {
        const text = allText.trim();
        if (!text) return;

        navigator.clipboard.writeText(text).then(() => {
          const btn = document.querySelector('button[onclick="copyText()"]');
          const original = btn.innerHTML;
          btn.innerHTML = "‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!!!";
          btn.style.background = "#4caf50";
          setTimeout(() => {
            btn.innerHTML = original;
            btn.style.background = "#2b6777";
          }, 1500);
        });
      };

      window.clearCurrentText = function () {
        allText = "";
        output.textContent = "[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà]";
      };

      window.saveToPage = function () {
        if (allText.trim() === "") {
          alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
          return;
        }

        const time = new Date().toLocaleTimeString("th-TH", { hour12: false });
        const date = new Date().toLocaleDateString("th-TH");
        const content = allText.trim();

        const newEntry = { date, time, text: content };
        const savedData = JSON.parse(localStorage.getItem("savedEntries") || "[]");
        savedData.push(newEntry);
        localStorage.setItem("savedEntries", JSON.stringify(savedData));

        renderEntry(newEntry);
        allText = "";
        output.textContent = "[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà]";
      };

      function renderEntry(entry) {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <div class="text-line">üìÖ [${entry.date} ${entry.time}] <span class="saved-text">${entry.text}</span></div>
          <div class="entry-buttons">
            <button onclick="copyEntry(this)">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            <button onclick="deleteEntry(this)">üóë ‡∏•‡∏ö</button>
          </div>
        `;
        if (saved.textContent === "[‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å]") saved.textContent = "";
        saved.appendChild(div);
      }

      window.copyEntry = function (btn) {
        const text = btn.closest(".entry").querySelector(".saved-text").innerText;
        navigator.clipboard.writeText(text).then(() => {
          const original = btn.innerHTML;
          btn.innerHTML = "‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!!!";
          btn.style.background = "#4caf50";
          setTimeout(() => {
            btn.innerHTML = original;
            btn.style.background = "#e0e0e0";
          }, 1500);
        });
      };

      window.deleteEntry = function (btn) {
        const entry = btn.closest(".entry");
        const text = entry.querySelector(".saved-text").innerText;
        const time = entry.querySelector(".text-line").innerText.match(/\[(.*?)\]/)?.[1] || "";

        let savedData = JSON.parse(localStorage.getItem("savedEntries") || "[]");
        savedData = savedData.filter(e => !(e.text === text && `${e.date} ${e.time}` === time));
        localStorage.setItem("savedEntries", JSON.stringify(savedData));

        entry.remove();
        if (saved.children.length === 0) {
          saved.textContent = "[‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å]";
        }
      };

      function loadSavedEntries() {
        const savedData = localStorage.getItem("savedEntries");
        if (!savedData) return;
        const entries = JSON.parse(savedData);
        if (entries.length > 0) saved.textContent = "";
        entries.forEach(renderEntry);
      }

      let audioContext, analyser, micSource, micInterval;

      function initMicMonitor() {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            navigator.mediaDevices.enumerateDevices().then(devices => {
              const mic = devices.find(d => d.kind === 'audioinput' && d.deviceId !== 'default');
              micDevice.textContent = mic
                ? `üéß ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡∏Ñ‡πå: ${mic.label || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}`
                : `üéß ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡∏Ñ‡πå`;
            });

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            micSource = audioContext.createMediaStreamSource(stream);
            micSource.connect(analyser);
            const dataArray = new Uint8Array(analyser.fftSize);

            micInterval = setInterval(() => {
              analyser.getByteTimeDomainData(dataArray);
              let sum = 0;
              for (let i = 0; i < dataArray.length; i++) {
                const val = (dataArray[i] - 128) / 128;
                sum += val * val;
              }
              const volume = Math.min(1, Math.sqrt(sum / dataArray.length) * 3);
              micLevel.style.width = `${volume * 100}%`;
            }, 100);
          })
          .catch(() => {
            micDevice.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡∏Ñ‡πå";
          });
      }

      function stopMicMonitor() {
        if (micInterval) clearInterval(micInterval);
        micLevel.style.width = "0%";
        if (audioContext) audioContext.close();
        status.textContent = "[‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß]";
      }

      document.addEventListener("keydown", function (event) {
        if (event.code === "Space") {
          event.preventDefault();
          isListening ? stopListening() : startListening();
        }

        if (event.key === "Control" && !event.repeat) {
          const text = allText.trim();
          if (!text) return;
          navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('button[onclick="copyText()"]');
            const original = btn.innerHTML;
            btn.innerHTML = "‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!!!";
            btn.style.background = "#4caf50";
            setTimeout(() => {
              btn.innerHTML = original;
              btn.style.background = "#2b6777";
            }, 1500);
          });
        }
      });

      window.addEventListener("DOMContentLoaded", loadSavedEntries);
    }
  </script>
</body>
</html>
